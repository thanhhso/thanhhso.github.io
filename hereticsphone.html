<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.0/addons/p5.dom.min.js"></script>
  <script src="https://unpkg.com/ml5@0.1.1/dist/ml5.min.js" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/gh/IDMNYU/p5.js-speech@0.0.3/lib/p5.speech.js"></script>
  <style>
    html, body {margin: 0; padding: 0; background-color: black; color: white;} canvas {display: block;}
  </style>
  <title>yes master</title>
</head>
<body>
<!-- <p id='status'>Loading Model...</p> -->
  <p>The Heretic's Phone labeled this as <span id="result">...</span>
  <!-- <br/>with a confidence of <span id="probability">...</span>. -->
  </p>

<script>
// let header;

//WikiHow
const api = 'https://www.wikihow.com/api.php?format=json&action=';
let temp_query; // fast temporary query
let query = 'person'; // detection -> temp_query -> query -> search term for wikiHowHTTP
let response; // all results from wikiHowHTTP
let commando; // randomized step 1 of results

// Ml5
let classifier;
let video;

// P5
let p5speech; // speech synthesis object

// Turn On / Off
let activateVoice = true;
let activateDetection = true;

let detection = []; // all spotted results from COCO

function preload() {
    wikiHowHTTTP(query);
}

function setup() {
    createCanvas(displayWidth, displayHeight - 100);
    // Check
    if ('ontouchstart' in document.documentElement == true) {
        console.log('mobile device')
        let constraints = {
            audio: false,
            video: {
                facingMode: {
                    exact: "environment"
                }
            }
        }
        video = createCapture(constraints);
    } else {
        console.log("NOT mobile device");
        video = createCapture(VIDEO);
    }
    video.hide();
    classifier = ml5.imageClassifier('MobileNet', video, modelReady); 
    p5speech = new p5.Speech(); 
}

function draw() {
    background('black');
    image(video, 0, 0, width, height);
}

setInterval(() => {
  if (activateDetection === true) {
    try {
    temp_query = detection; //
    } catch (error) {
    temp_query = undefined  //
    }
    console.log('>', temp_query)
    query = temp_query;
  } else {
    console.log('activateDetection,', false);
  }
}, 500);

setInterval(function(){ 
if (activateVoice === true) {

/// WikiHow API Stuff
console.log('>>> ', query);
if (!response) {
// Wait until the WikiHow data has loaded before drawing.
return;
}
wikiHowHTTTP(query);
commando = random(response.query.search);
commando = commando['title'] // filter out 'title:' from object
console.log(commando);

//textToSpeech
let speechSeq1 = "I see, ";
let speechSeq2 = ", so you will, ";
// let speechSeq3 = ", my slave!";
textToSpeech(1, speechSeq1 + query + speechSeq2 + commando);
commando = "";

} else { console.log('activateVoice', false) }

}, 8000);//run this thang every 5 seconds


// Get a prediction for the current video frame
function classifyVideo() {
  classifier.predict(gotResult);
}

function gotResult(err, results) {
  // The results are in an array ordered by probability.
  console.log(results[0].className)
  detection = results[0].className;
  detection = detection.split(',')[0];  // take only the first word after first ','
  select('#result').html(results[0].className);
  //    console.log(results[0].className ,results[0].probability);
  //    select('#probability').html(nf(results[0].probability, 0, 2));
  classifyVideo();
}

function textToSpeech(voice_number, inputText) {
  const msg = new SpeechSynthesisUtterance();
  const voices = p5speech.voices;
  const voice = voices[voice_number];

  msg.text = inputText;
  p5speech.setVoice(voice.name);
  p5speech.setRate(0.85);
  p5speech.setPitch(0.2);
  
  console.log('speak: ', inputText)
  p5speech.speak(inputText); // starting speaking
}

function wikiHowHTTTP(q) {
// Get the 10 first results from the WikiHow database using the query
let url = api + 'query&format=json&utf8=&list=search&srsearch=' + q + "&srlimit=" + 10;
httpGet(url, 'jsonp', false, function(r) {
// when the HTTP request completes, populate the variable that holds the results data
response = r;
});
if (!response) {
// Wait until the WikiHow data has loaded before drawing.
return;
}
}

function modelReady() {
  console.log('Model Loaded');
  // Change the status of the model once its ready
  // select('#status').html('Model Loaded');
  // Call the classifyVideo function to start classifying the video
  classifyVideo();
}
</script>
</body>
</html>